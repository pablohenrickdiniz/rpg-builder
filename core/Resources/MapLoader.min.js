define(["Map","jquery","MaterialsLoader","ImageSet","ImageLoader"],function(c,e,d,a,b){return{maps:[],load:function(h,j){var g=this;var f=document.createElement("a");f.href=h;h=e(f).prop("href");var i=h.substring(0,h.lastIndexOf("/"));if(g.maps[h]==undefined){console.log("loading map "+h);e.ajax({url:h,type:"get",dataType:"json",success:function(k){console.log("map loaded...");g.createMapObject(k,j,i)}})}else{j(g.maps[h])}},createMapObject:function(h,j,g){console.log("creating map object...");g=g==undefined?"":g;var i=new c({tile_w:h.tile_w,tile_h:h.tile_h});var f=g+"/"+h.materials;d.load(f,function(w,n){var l=[];var t=[];var m=0;var z=h.map.length;for(var v=0;v<z;v++){if(l[v]==undefined){l[v]=[]}var o=h.map[v].length;m=Math.max(m,o);for(var u=0;u<o;u++){if(l[v][u]==undefined){l[v][u]=[]}for(var q=0;q<h.map[v][u].length;q++){var A=h.map[v][u][q];var k=A[0].split("-");var p=k[0];var r=k[1].split(".");r[0]=parseInt(r[0]);r[1]=parseInt(r[1]);var s=n+"/"+w.tilesets[p];l[v][u][q]=new a({url:s,x:i.tile_w*u,y:i.tile_h*v,sx:i.tile_w*r[1],sy:i.tile_h*r[0],width:i.tile_w,height:i.tile_h,layer:q});t.push(s)}}}b.loadAll(t,function(){i.set({width:m,height:z,imageSets:l});j(i)})})}}});