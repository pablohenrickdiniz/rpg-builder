app.controller("MapEditorController",["$location","$rootScope","$localStorage","ImageLoader","$timeout",function(f,b,e,d,c){var a=this;a.mapCanvas=null;a.tilesetCanvas=null;a.tilesetLayer=null;a.selectedInterval=null;a.map=null;b.currentLayer=0;b.layers=[];b.storage=e;b.grid={width:32,height:32,active:true};b.graphic={gridColor:"#FFFFFF"};b.tilesetData={graphic:{gridColor:"#FFFFFF",rows:1,cols:1,imageData:{url:""},image:null}};b.modalVisible=false;b.showModal=function(){b.modalVisible=true};b.hideModal=function(){b.modalVisible=false};b.init=function(){b.page.title="Editor de Mapas";b.initController()};b.initController=function(){var l=a.getMapCanvas();var k=a.getTilesetCanvas();var j=new CE.EXT.AbstractGrid({sw:32,sh:32});var h=l.getGridLayer();h.setGrid(j);h.set({opacity:0.3});h.refresh();a.tilesetLayer=k.createLayer({name:"tileset-layer"});h=k.getGridLayer();h.set({opacity:0.8});h.refresh();for(var g=0;g<10;g++){b.layers[g]=l.createLayer()}l.getMouseReader().onmousemove(function(){var i=this;if(i.right){var m=l.getGridLayer();m.refresh();a.getMap().draw(b.layers,m.getVisibleArea())}})};b.changeGraphic=function(g){b.modalVisible=false;b.tilesetData.graphic.imageData.url=g};b.changeMapWidth=function(g){var j=a.getMapCanvas();var i=a.getMap();j.applyToLayers({width:i.tile_w*g});var h=j.getGridLayer();h.getGrid().set({width:i.tile_w*g});h.refresh();a.getMap().draw(b.layers,h.getVisibleArea())};b.changeMapHeight=function(g){var j=a.getMapCanvas();var i=a.getMap();j.applyToLayers({height:i.tile_h*g});var h=j.getGridLayer();h.getGrid().set({height:i.tile_h*g});h.refresh();a.getMap().draw(b.layers,h.getVisibleArea())};b.$watch("tilesetData.graphic.imageData.url",function(h,g){c(function(){if(h!==g&&a.tilesetLayer!==null){d.load(h,function(j){b.tilesetData.graphic.image=j;var k=a.getTilesetCanvas();k.set({viewX:0,viewY:0});k.applyToLayers({width:j.width,height:j.height});a.tilesetLayer.clear().drawImage(j,0,0);var i=k.getGridLayer();i.getGrid().set({width:j.width,height:j.height,sw:j.width,sh:j.height});i.refresh();c(function(){var l=Math.floor(j.height/32);var m=Math.floor(j.width/32);l=l<1?1:l;m=m<1?1:m;b.tilesetData.graphic.rows=l;b.tilesetData.graphic.cols=m;b.changeRows(l);b.changeCols(m)})})}})});b.changeRows=function(i){var h=b.tilesetData.graphic.image;if(h!==null){var g=a.getTilesetCanvas().getGridLayer();g.getGrid().set({sh:h.height/i});g.refresh()}};b.changeCols=function(i){var h=b.tilesetData.graphic.image;if(h!==null){var g=a.getTilesetCanvas().getGridLayer();g.getGrid().set({sw:h.width/i});g.refresh()}};b.changeLayer=function(g){b.currentLayer=g};a.getMapCanvas=function(){if(a.mapCanvas===null){a.mapCanvas=CE.createEngine({container:"#canvas-map",width:600,height:600,draggable:true},CE.EXT.CanvasEngineGrid);a.mapCanvas.getMouseReader().onmousemove(function(){var r=this;if(r.left&&a.selectedInterval!==null){var v=a.getMapCanvas();var g=a.getMap();var m=b.tilesetData.graphic.image;var k=a.selectedInterval;var h=v.getDrawedArea();var p=g.getAreaInterval(h);var q=b.layers[b.currentLayer];for(var o=p.si,w=k.si;o<=p.ei;o++){for(var n=p.sj,l=k.sj;n<=p.ej;n++){var u=n*g.tile_w;var t=o*g.tile_h;var s={image:m,dWidth:g.tile_w,dHeight:g.tile_h,sWidth:g.tile_w,sHeight:g.tile_h,sx:l*g.tile_w,sy:w*g.tile_h,dx:u,dy:t,layer:b.currentLayer};q.clearRect({x:u,y:t,width:g.tile_w,height:g.tile_h});q.image(s);g.setTile(o,n,s);l++;if(l>k.ej){l=k.sj}}w++;if(w>k.ei){w=k.si}}}})}return a.mapCanvas};a.getTilesetCanvas=function(){if(a.tilesetCanvas===null){a.tilesetCanvas=CE.createEngine({container:"#tileset",width:520,height:520,selectable:true,draggable:true,multiSelect:true},CE.EXT.CanvasEngineGrid);a.tilesetCanvas.onAreaSelect(function(l,k){var g=this.getMouseReader();if(g.left){var m=k.getRectsFromArea(l);var j=k.getAreaInterval(l);k.apply({fillStyle:"transparent",state:0});m.forEach(function(n){n.set({fillStyle:"rgba(0,0,100,0.5)",state:1})});a.selectedInterval=j}else{var i=k.getRectsFromArea(l);if(i.length>0){var h=i[0];k.apply({fillStyle:"transparent"},function(){return this.state!=1});h.set({fillStyle:"rgba(0,0,100,0.5)"})}}})}return a.tilesetCanvas};a.getMap=function(){var g=this;if(g.map===null){var h=g.getMapCanvas();g.map=new CE.EXT.Map({sw:32,sh:32,width:h.getWidth()/32,height:h.getHeight()/32})}return g.map}}]);