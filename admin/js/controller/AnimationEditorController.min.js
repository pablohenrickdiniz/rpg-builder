app.controller("AnimationEditorController",["$rootScope","ImageLoader","$localStorage","$timeout",function(b,e,c,d){var a=this;a.animationImage=null;a.graphicLayer=null;a.graphics=[];a.animation=null;a.playing=false;a.rows=1;a.cols=1;a.maxLayer=0;a.selectedObject=null;b.init=function(){b.page.title="Editor de Animações";b.initController()};b.modalVisible=false;b.storage=c;b.canvasId="canvas-container";b.animationData={graphic:{rows:1,cols:1,gridColor:"#000000",images:[],imageData:{url:""},image:null,croppedArea:{}},currentFrame:0};b.animation=null;b.changeRows=function(g){b.animationData.graphic.rows=g;var f=b.animationData.graphic.image;if(f!==null){a.getAnimationImage().updateGrid({sh:f.height/g})}};b.changeCols=function(g){b.animationData.graphic.cols=g;var f=b.animationData.graphic.image;if(f!==null){a.getAnimationImage().updateGrid({sw:f.width/g})}};b.addImages=function(f){b.animationData.graphic.images=b.animationData.graphic.images.concat(f)};b.$watch("animationData.graphic.imageData.url",function(g,f){d(function(){if(g!==f&&a.graphicLayer!==null){e.load(g,function(h){b.animationData.graphic.image=h;a.graphicLayer.set({width:h.width,height:h.height}).clear().drawImage(h,0,0);a.getAnimationImage().updateGrid({width:h.width,height:h.height,sw:h.width,sh:h.height})})}})});b.changeGraphic=function(f){b.animationData.graphic.imageData.url=f;b.modalVisible=false};b.changeGridColor=function(f){b.animationData.graphic.gridColor=f;var g=a.getAnimationImage();var h=g.getGrid();h.apply({strokeStyle:f});g.redrawGrid()};b.addFrame=function(f){b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer);a.getAnimation().indexFrame=f;a.addObject()};b.selectFrame=function(f){console.log("selecting frame "+f);a.getAnimation().indexFrame=f;b.animationCanvas.layers.forEach(function(h,g){if(h.type!=="grid"){if(g===f){h.opacity=1}else{h.opacity=0}}})};b.initController=function(){b.animationCanvas=CE.createEngine({container:"#canvas-container",width:535,height:400});var h=a.getAnimationImage();a.graphicLayer=h.createLayer({name:"graphic-layer"});var i=b.animationCanvas;var g=i.getMouseReader();var f=i.getKeyReader();i.getGridLayer({append:false,width:i.width,height:i.height});f.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(a.selectedObject!==null&&a.selectedObject.parent!==null){var j=a.selectedObject;var k=j.parent;k.remove(a.selectedObject);a.selectedObject=null;a.getAnimation().frames.forEach(function(m){var l=m.imageSets.indexOf(j);if(l!==-1){m.removeImageSet(j);return false}})}});f.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_UP],function(){var j=a.selectedObject;if(j!==null){if(j.parent!==null){j.parent.moveUp(j)}}});f.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_DOWN],function(){var j=a.selectedObject;if(j!==null){if(j.parent!==null){j.parent.moveDown(j)}}});g.onmousedown(1,function(){var j=this;var o=j.lastDown.left;var l=a.frameLayers[b.animation.indexFrame];if(l!==undefined){var n=l.objects;var k=null;var m=false;if(a.selectedObject!==null){a.selectedObject.selected=false;a.selectedObject.parent.refresh();a.selectedObject=null}n.forEach(function(q){var p=o.x-q.x;var r=o.y-q.y;if(!q.isTransparent(p,r)){k=q;k.selected=true;k.oldX=k.x;k.oldY=k.y;a.selectedObject=k;m=true;l.refresh();return false}if(m){return false}})}});g.onmousemove(function(){var s=this;var o=a.selectedObject;if(s.left&&o!==null){var j=s.lastDown.left;var n=s.lastMove;var u=Math.vmv(n,j);var t={x:u.x+o.oldX,y:u.y+o.oldY};var k=i.getGrid().width;var v=i.getGrid().height;var m=Math.floor(t.x/32)*32;var r=Math.floor(t.y/32)*32;var l=m+32;var q=r+32;if((t.x-m)<(l-(t.x+o.width))){t.x=m}else{t.x=l}if((t.y-r)<=(q-(t.y+o.height))){t.y=r}else{t.y=q}o.set(t);if(o.parent!==null){o.parent.refresh()}}})};a.getAnimationImage=function(){var g=this;if(g.animationImage===null){g.animationImage=CE.createEngine({container:"#animations",width:530,height:400,selectable:true,draggable:true,scalable:true});var h=function(q,p){var o=g.animationImage.getGrid();var r=null;if(o.checkedSets.length>0){r=o.checkedSets[0]}if(r!==null){var n=o.rectSets[r.i+q]!==undefined?r.i+q:0;var l=o.rectSets[n][r.j+p]!==undefined?r.j+p:0;if(o.rectSets[n][l]!==undefined){var m=o.rectSets[n][l];o.checkedSets=[m];o.apply({fillStyle:"transparent",state:0});m.set({fillStyle:"rgba(0,0,150,0.5)",state:1});g.animationImage.refreshGridLayer();var k=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:m.x,sy:m.y,sWidth:m.width,sHeight:m.height,dWidth:m.width,dHeight:m.height,x:(k.width/2)-(m.width/2),y:(k.height/2)-(m.height/2)}}}};var f=g.animationImage.getKeyReader();f.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){console.log("keydown!");h(1,0)});f.onSequence([CE.KeyReader.Keys.KEY_UP],function(){console.log("keydown!");h(-1,0)});f.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){console.log("keydown!");h(0,-1)});f.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){console.log("keydown!");h(0,1)});f.onSequence([CE.KeyReader.Keys.KEY_F],function(){g.addFrame()});f.onSequence([CE.KeyReader.Keys.KEY_O],function(){g.addObject()});g.animationImage.onAreaSelect(function(n,l){var i=g.animationImage.getMouseReader();var j=l.getRectsFromArea(n);l.checkedSets=j;if(i.left){l.apply({fillStyle:"transparent"});j.forEach(function(o){o.set({fillStyle:"rgba(0,0,150,0.5)",state:1})})}else{l.apply({fillStyle:"transparent"},function(){return this.state!==1});j.forEach(function(o){if(o.state!==1){o.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}})}if(j.length>0){var m=j[0];var k=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:m.x,sy:m.y,dWidth:m.width,dHeight:m.height,sWidth:m.width,sHeight:m.height,x:(k.width/2)-(m.width/2),y:(k.height/2)-(m.height/2)}}})}return g.animationImage};b.removeFrame=function(f){b.animationCanvas.removeLayer(f);b.selectFrame(f-1)};a.getAnimation=function(){var f=this;var g=b.animationCanvas;if(b.animation===null){var h=new CE.Animation({speed:7,width:g.width,height:g.height,indexFrame:0});h.onStep(function(i){b.selectFrame(i)});b.animation=h}return b.animation};a.addObject=function(){var f=this;if(b.animationData.graphic.croppedArea!==null){var i=b.animation.indexFrame;var g=b.animationCanvas.getLayer(i);if(g!==null&&g instanceof CE.ObjectLayer){var h=_.clone(b.animationData.graphic.croppedArea);g.add(h);f.getAnimation().frames[i]=h}}};b.showModal=function(){b.modalVisible=true};b.hideModal=function(){b.modalVisible=false}}]);