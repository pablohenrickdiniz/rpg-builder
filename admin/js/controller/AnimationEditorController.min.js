app.controller("AnimationEditorController",["$rootScope","ImageLoader","$localStorage","$timeout","Utils",function(b,e,c,d,f){var a=this;a.graphicLayer=null;a.graphics=[];a.animation=null;a.rows=1;a.cols=1;a.maxLayer=0;a.frameLayers=[];a.resize_active=false;a.resize_vertex=null;a.object_data={old_width:0,old_height:0,old_x:0,old_y:0};b.modalVisible=false;b.storage=c;b.canvasId="canvas-container";b.hoverObject=null;b.currentObject=null;b.loadingImage=false;b.animationImage=null;b.objectMenu=false;b.gridMenu=false;b.tool="one";b.$watch("tool",function(h,g){if(h!==g){switch(h){case"one":a.getAnimationImage().set({multiSelect:false});break;case"group":a.getAnimationImage().set({multiSelect:true});break}}});b.init=function(){b.page.title="Editor de Animações";b.initController()};b.animationData={graphic:{rows:1,cols:1,gridColor:"#000000",images:[],imageData:{url:""},image:null,croppedArea:{}},currentFrame:0};b.grid={width:32,height:32,active:true};b.cursor={x:0,y:0,style:null};b.animation=null;b.$watchGroup(["currentObject.dx","currentObject.dy","currentObject.dWidth","currentObject.dHeight"],function(h,g){h.forEach(function(j,i){if(g[i]!==h[i]){if(b.currentObject!==null&&b.currentObject.canvasLayer!==undefined){b.currentObject.canvasLayer.refresh()}return false}})});b.changeRows=function(h){var g=b.animationData.graphic.image;if(g!==null){a.getAnimationImage().updateGrid({sh:g.height/h})}};b.changeCols=function(h){var g=b.animationData.graphic.image;if(g!==null){a.getAnimationImage().updateGrid({sw:g.width/h})}};b.addImages=function(g){b.animationData.graphic.images=b.animationData.graphic.images.concat(g)};b.$watch("animationData.graphic.imageData.url",function(h,g){d(function(){if(h!==g&&a.graphicLayer!==null){e.load(h,function(j){b.animationData.graphic.image=j;var k=a.getAnimationImage();k.applyToLayers({width:j.width,height:j.height});a.graphicLayer.clear().drawImage(j,0,0);k.updateGrid({width:j.width,height:j.height,sw:j.width,sh:j.height});var l=new ColorThief();var m=l.getColor(j);var i=new CE.Color({red:m[0],blue:m[1],green:m[2]}).reverse();d(function(){b.changeGridColor(i.toHEX());b.changeRows(b.animationData.graphic.rows);b.changeCols(b.animationData.graphic.cols)})})}})});b.changeGraphic=function(g){b.animationData.graphic.imageData.url=g;b.modalVisible=false};b.changeGridColor=function(g){b.animationData.graphic.gridColor=g;var h=a.getAnimationImage();var i=h.getGrid();i.apply({strokeStyle:g});h.redrawGrid()};b.addFrame=function(h){b.stopAnimation();var g=b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer);a.getAnimation().indexFrame=h;b.addObject();a.frameLayers.push(g);b.selectFrame(h)};b.selectFrame=function(g){console.log("selecting frame "+g);a.getAnimation().indexFrame=g;b.animationCanvas.layers.forEach(function(i,h){if(i.type!=="grid"){if(h===g){i.opacity=1}else{i.opacity=0}}})};b.initController=function(){b.animationCanvas=CE.createEngine({container:"#canvas-container",width:535,height:400});a.getAnimation().stop();var i=a.getAnimationImage();a.graphicLayer=i.createLayer({name:"graphic-layer"});var j=b.animationCanvas;var h=j.getMouseReader();var g=j.getKeyReader();$(document).on("keydown",function(k){});j.getGridLayer({append:false,width:j.width,height:j.height});g.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(b.currentObject!==null&&b.currentObject.canvasLayer!==null){b.currentObject.canvasLayer.remove(b.currentObject);b.currentObject=null}});g.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_GT],function(){var k=b.currentObject;if(k!==null&&k.canvasLayer!==null){k.canvasLayer.moveUp(k)}});g.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_LT],function(){var k=b.currentObject;if(k!==null&&k.canvasLayer!==null){k.canvasLayer.moveDown(k)}});h.onmousedown(1,function(){if(!a.resize_active){var k=this;var n=k.lastDown.left;var l=a.frameLayers[a.getAnimation().indexFrame];if(l!==undefined){var m=l.objects;if(b.currentObject!==null){b.currentObject.selected=false;b.currentObject=null}m.forEach(function(p){var u=n.x-p.dx;var t=n.y-p.dy;if(u>=0&&t>=0&&u<=p.dWidth&&t<=p.dHeight){var s=p.dWidth/p.sWidth;var o=p.dHeight/p.sHeight;var r=(u/s);var q=(t/o);var w=r+p.sx;var v=q+p.sy;if(!f.isPixelTransparent(p.image,w,v)){p.selected=true;p.odx=p.dx;p.ody=p.dy;b.currentObject=p;return false}}});l.refresh()}}});h.onmouseout(function(){b.cursor={x:0,y:0};b.hoverObject=null;b.$apply()});h.onmousemove(function(){var l=this;var H=l.lastMove;b.cursor=H;b.$apply();var N=a.frameLayers[a.getAnimation().indexFrame];if(N!==undefined){var k=N.objects;b.hoverObject=null;k.forEach(function(P){var U=H.x-P.dx;var T=H.y-P.dy;if(U>0&&T>0&&U<=P.dWidth&&T<=P.dHeight){var S=P.dWidth/P.sWidth;var p=P.dHeight/P.sHeight;var R=(U/S);var Q=(T/p);var W=R+P.sx;var V=Q+P.sy;if(!f.isPixelTransparent(P.image,W,V)){b.hoverObject=P;return false}}})}if(b.currentObject!==null){var O=b.currentObject;if(l.left){var G=l.lastDown.left;var B=CE.Math.vmv(H,G);if(a.resize_vertex!==null){if([0,6,7].indexOf(a.resize_vertex)!==-1){var v=Math.max(a.object_data.old_width-B.x,1);var x=v-a.object_data.old_width;var q=a.object_data.old_x-x;O.dWidth=v;O.dx=q}else{if([2,3,4].indexOf(a.resize_vertex)!==-1){O.dWidth=Math.max(a.object_data.old_width+B.x,1)}}if([0,1,2].indexOf(a.resize_vertex)!==-1){var t=Math.max(a.object_data.old_height-B.y,1);var w=t-a.object_data.old_height;var z=a.object_data.old_y-w;O.dHeight=t;O.dy=z}else{if([4,5,6].indexOf(a.resize_vertex)!==-1){O.dHeight=Math.max(a.object_data.old_height+B.y,1)}}}else{var A=B.x+O.odx;var y=B.y+O.ody;if(b.grid.active){var I=j.getGrid().width;var D=j.getGrid().height;var F=b.grid.width;var M=b.grid.height;var E=Math.floor(A/F)*F;var s=Math.floor(y/M)*M;var C=E+F;var r=s+M;if((A-E)<(C-(A+O.dWidth))){A=E}else{A=C}if((y-s)<=(r-(y+O.dHeight))){y=s}else{y=r}}O.dx=A;O.dy=y}}else{var L=O.dx-3;var K=L+(O.dWidth/2);var J=L+O.dWidth;var o=O.dy-3;var n=o+(O.dHeight/2);var m=o+O.dHeight;var u=null;a.resize_vertex=null;if(H.x>=L&&H.x<=L+6){if(H.y>=o&&H.y<=o+6){u="nwse-resize";a.resize_vertex=0}else{if(H.y>=n&&H.y<=n+6){u="ew-resize";a.resize_vertex=7}else{if(H.y>=m&&H.y<=m+6){u="nesw-resize";a.resize_vertex=6}}}}else{if(H.x>=K&&H.x<=K+6){if(H.y>=o&&H.y<=o+6){u="ns-resize";a.resize_vertex=1}else{if(H.y>=m&&H.y<=m+6){u="ns-resize";a.resize_vertex=5}}}else{if(H.x>=J&&H.x<=J+6){if(H.y>=o&&H.y<=o+6){a.resize_vertex=2;u="nesw-resize"}else{if(H.y>=n&&H.y<=n+6){a.resize_vertex=3;u="ew-resize"}else{if(H.y>=m&&H.y<=m+6){a.resize_vertex=4;u="nwse-resize"}}}}}}if(a.resize_vertex!==null){a.object_data={old_x:O.dx,old_y:O.dy,old_width:O.dWidth,old_height:O.dHeight}}a.resize_active=(u!==null);b.cursor.style=u;b.$apply()}}})};a.getAnimationImage=function(){var h=this;if(b.animationImage===null){b.animationImage=CE.createEngine({container:"#animations",width:500,height:500,selectable:true,draggable:true,scalable:true});var i=function(q,p){var o=b.animationImage.getGrid();var r=null;if(o.checkedSets.length>0){r=o.checkedSets[0]}if(r!==null){var n=o.rectSets[r.i+q]!==undefined?r.i+q:0;var l=o.rectSets[n][r.j+p]!==undefined?r.j+p:0;if(o.rectSets[n][l]!==undefined){var m=o.rectSets[n][l];o.checkedSets=[m];o.apply({fillStyle:"transparent",state:0});m.set({fillStyle:"rgba(0,0,150,0.5)",state:1});b.animationImage.refreshGridLayer();var k=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:m.x,sy:m.y,sWidth:m.width,sHeight:m.height,dWidth:m.width,dHeight:m.height,dx:(k.width/2)-(m.width/2),dy:(k.height/2)-(m.height/2)};b.$apply()}}};var g=b.animationImage.getKeyReader();g.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){i(1,0)});g.onSequence([CE.KeyReader.Keys.KEY_UP],function(){i(-1,0)});g.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){i(0,-1)});g.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){i(0,1)});g.onSequence([CE.KeyReader.Keys.KEY_F],function(){h.addFrame()});g.onSequence([CE.KeyReader.Keys.KEY_O],function(){b.addObject()});b.animationImage.onAreaSelect(function(o,m){var j=b.animationImage.getMouseReader();var k=m.getRectsFromArea(o);m.checkedSets=k;if(j.left){m.apply({fillStyle:"transparent"});k.forEach(function(p){p.set({fillStyle:"rgba(0,0,150,0.5)",state:1})});b.$apply()}else{m.apply({fillStyle:"transparent"},function(){return this.state!==1});k.forEach(function(p){if(p.state!==1){p.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}});b.$apply()}if(k.length>0){var n=k[0];var l=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:n.x,sy:n.y,dWidth:n.width,dHeight:n.height,sWidth:n.width,sHeight:n.height,dx:(l.width/2)-(n.width/2),dy:(l.height/2)-(n.height/2)}}})}return b.animationImage};b.removeFrame=function(g){b.animationCanvas.removeLayer(g);a.frameLayers.splice(g,1);a.getAnimation().remove(g);b.selectFrame(g-1)};a.getAnimation=function(){var g=this;var h=b.animationCanvas;if(b.animation===null){var i=new CE.Animation({speed:7,width:h.width,height:h.height,indexFrame:0,repeat:true});i.onStep(function(j){b.selectFrame(j);b.$apply()});b.animation=i}return b.animation};b.addObject=function(){if(b.animationData.graphic.croppedArea!==null&&b.animation!==null){var i=b.animation.indexFrame;var g=b.animationCanvas.getLayer(i);if(g!==null&&g instanceof CE.ObjectLayer){var h=new CE.ImageSet(b.animationData.graphic.croppedArea);h.selected=true;if(b.currentObject!==null){b.currentObject.selected=false}g.add(h);a.getAnimation().frames[i]=h;g.refresh()}}};b.showModal=function(){b.modalVisible=true};b.hideModal=function(){b.modalVisible=false};b.playAnimation=function(){a.frameLayers.forEach(function(g){g.objects.forEach(function(h){h.selected=false});g.refresh()});a.getAnimation().execute()};b.pauseAnimation=function(){a.getAnimation().pause()};b.stopAnimation=function(){a.getAnimation().stop();b.selectFrame(0)};b.changeSpeed=function(g){a.getAnimation().speed=g};b.showGridMenu=function(){b.gridMenu=true};b.hideGridMenu=function(){b.gridMenu=false};b.showObjectMenu=function(){b.objectMenu=true};b.hideObjectMenu=function(){b.objectMenu=false};b.selectTool=function(g){b.tool=g}}]);