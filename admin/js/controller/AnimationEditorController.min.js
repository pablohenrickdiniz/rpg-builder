app.controller("AnimationEditorController",["$rootScope","ImageLoader","$timeout",function(b,d,c){var a=this;b.init=function(){b.page.title="Editor de Animações"};b.canvasId="canvas-container";b.animationData={animation:{frames:[]},layers:{canvas:[],width:560,height:400,visible:null},graphic:{rows:1,cols:1,gridColor:"#000000",images:[],image:null}};b.changeRows=function(e){b.animationData.graphic.rows=e;a.changeRows(e)};b.changeCols=function(e){b.animationData.graphic.cols=e;a.changeCols(e)};b.addImages=function(e){b.animationData.graphic.images=b.animationData.graphic.images.concat(e)};b.changeGraphic=function(){a.changeGraphic(b.animationData.graphic.image.url)};b.changeGridColor=function(e){b.graphic.gridColor=e;a.changeGridColor(b.animationData.graphic.gridColor)};b.addFrame=function(){b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer)};b.selectFrame=function(e){b.animationData.layers.visible=e};b.animationCanvas=CE.createEngine({container:"#canvas-container",width:560,height:400});b.refresh=function(){console.log("refreshing layers...");c(function(){b.animationCanvas.updateGrid({width:b.animationCanvas.width,height:b.animationCanvas.height,sw:32,sh:32,opacity:0.1})})};a.animationImage=null;a.graphicLayer=null;a.frameLayers=[];a.currentFrame=0;a.graphics=[];a.image=null;a.croppedImage=null;a.animation=null;a.playing=false;a.rows=1;a.cols=1;a.maxLayer=0;a.selectedObject=null;b.initController=function(){var g=a.getAnimationImage();a.graphicLayer=g.createLayer({name:"graphic-layer"});var h=b.animationCanvas;var f=h.getMouseReader();var e=h.getKeyReader();h.getGridLayer({append:false,width:h.width,height:h.height});e.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(a.selectedObject!==null&&a.selectedObject.parent!==null){var i=a.selectedObject;var j=i.parent;j.remove(a.selectedObject);a.selectedObject=null;a.getAnimation().frames.forEach(function(l){var k=l.imageSets.indexOf(i);if(k!==-1){l.removeImageSet(i);return false}})}});e.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_UP],function(){var i=a.selectedObject;if(i!=null){if(i.parent!=null){i.parent.moveUp(i)}}});e.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_DOWN],function(){var i=a.selectedObject;if(i!=null){if(i.parent!=null){i.parent.moveDown(i)}}});f.onmousedown(1,function(){var i=this;var n=i.lastDown.left;var k=a.frameLayers[a.currentFrame];if(k!=undefined){var m=k.objects;var j=null;var l=false;if(a.selectedObject!==null){a.selectedObject.selected=false;a.selectedObject.parent.refresh();a.selectedObject=null}m.forEach(function(p){var o=n.x-p.x;var q=n.y-p.y;if(!p.isTransparent(o,q)){j=p;j.selected=true;j.oldX=j.x;j.oldY=j.y;a.selectedObject=j;l=true;k.refresh();return false}if(l){return false}})}});f.onmousemove(function(){var r=this;var n=a.selectedObject;if(r.left&&n!==null){var i=r.lastDown.left;var m=r.lastMove;var t=Math.vmv(m,i);var s={x:t.x+n.oldX,y:t.y+n.oldY};var j=h.getGrid().width;var u=h.getGrid().height;var l=Math.floor(s.x/32)*32;var q=Math.floor(s.y/32)*32;var k=l+32;var o=q+32;if((s.x-l)<(k-(s.x+n.width))){s.x=l}else{s.x=k}if((s.y-q)<=(o-(s.y+n.height))){s.y=q}else{s.y=o}n.set(s);if(n.parent!==null){n.parent.refresh()}}})};a.getAnimationImage=function(){var f=this;if(f.animationImage===null){f.animationImage=CE.createEngine({container:"#animations",width:560,height:400,selectable:true,draggable:true,scalable:true});var g=function(p,o){var n=f.animationImage.getGrid();var q=null;if(n.checkedSets.length>0){q=n.checkedSets[0]}if(q!==null){var m=n.rectSets[q.i+p]!==undefined?q.i+p:0;var k=n.rectSets[m][q.j+o]!==undefined?q.j+o:0;if(n.rectSets[m][k]!==undefined){var l=n.rectSets[m][k];n.checkedSets=[l];n.apply({fillStyle:"transparent",state:0});l.set({fillStyle:"rgba(0,0,150,0.5)",state:1});f.animationImage.refreshGridLayer();var h=b.animationCanvas;f.croppedImage=new CE.ImageSet({url:f.image.src,sx:l.x,sy:l.y,width:l.width,height:l.height});f.croppedImage.set({x:(h.getWidth()/2)-(l.width/2),y:(h.getHeight()/2)-(l.height/2)})}}};var e=f.animationImage.getKeyReader();e.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){console.log("keydown!");g(1,0)});e.onSequence([CE.KeyReader.Keys.KEY_UP],function(){console.log("keydown!");g(-1,0)});e.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){console.log("keydown!");g(0,-1)});e.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){console.log("keydown!");g(0,1)});e.onSequence([CE.KeyReader.Keys.KEY_F],function(){f.addFrame()});e.onSequence([CE.KeyReader.Keys.KEY_O],function(){f.addObject()});f.animationImage.onAreaSelect(function(m,k){var h=f.animationImage.getMouseReader();var i=k.getRectsFromArea(m);k.checkedSets=i;if(h.left){k.apply({fillStyle:"transparent"});i.forEach(function(n){n.set({fillStyle:"rgba(0,0,150,0.5)",state:1})})}else{k.apply({fillStyle:"transparent"},function(){return this.state!=1});i.forEach(function(n){if(n.state!==1){n.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}})}if(i.length>0){var l=i[0];var j=b.animationCanvas;f.croppedImage=new CE.ImageSet({url:f.image.src,sx:l.x,sy:l.y,width:l.width,height:l.height,sWidth:l.width,sHeight:l.height});f.croppedImage.set({x:(j.getWidth()/2)-(l.width/2),y:(j.getHeight()/2)-(l.height/2)})}})}return f.animationImage};a.changeGraphic=function(f){var e=this;d.load(f,function(g){e.image=g;e.graphicLayer.set({width:g.width,height:g.height}).clear().drawImage(g,0,0);e.getAnimationImage().updateGrid({width:g.width,height:g.height,sw:g.width,sh:g.height})})};a.changeRows=function(f){var e=this;if(e.image!==null){e.getAnimationImage().updateGrid({sh:e.image.height/f})}e.rows=f};a.changeCols=function(f){var e=this;if(e.image!==null){e.getAnimationImage().updateGrid({sw:e.image.width/f})}e.cols=f};a.changeGridColor=function(f){var e=this;var g=e.getAnimationImage();var h=g.getGrid();h.apply({strokeStyle:f});g.redrawGrid()};b.removeFrame=function(e){b.animationCanvas.removeLayer(e);b.refresh()};a.getAnimation=function(){var e=this;var f=b.animationCanvas;if(e.animation===null){e.animation=new CE.Animation({speed:7,width:f.width,height:f.height});e.animation.onStep(function(g){e.getFrameList().itemSelect(g)})}return e.animation};a.addObject=function(){var e=this;if(e.croppedImage!==null){var f=b.animationCanvas.getLayer(e.currentFrame);if(f!==null&&f instanceof CE.ObjectLayer){var g=e.croppedImage.clone();f.add(g);e.getAnimation().frames[e.currentFrame]=g.getGraphic()}}}}]);