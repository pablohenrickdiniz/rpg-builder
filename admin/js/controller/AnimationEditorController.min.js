app.controller("AnimationEditorController",["$rootScope","ImageLoader","$localStorage","$timeout","Utils",function(b,e,c,d,f){var a=this;a.animationImage=null;a.graphicLayer=null;a.graphics=[];a.animation=null;a.rows=1;a.cols=1;a.maxLayer=0;a.selectedObject=null;a.frameLayers=[];b.init=function(){b.page.title="Editor de Animações";b.initController()};b.modalVisible=false;b.storage=c;b.canvasId="canvas-container";b.animationData={graphic:{rows:1,cols:1,gridColor:"#000000",images:[],imageData:{url:""},image:null,croppedArea:{}},currentFrame:0};b.cursor={x:0,y:0};b.animation=null;b.changeRows=function(h){b.animationData.graphic.rows=h;var g=b.animationData.graphic.image;if(g!==null){a.getAnimationImage().updateGrid({sh:g.height/h})}};b.changeCols=function(h){b.animationData.graphic.cols=h;var g=b.animationData.graphic.image;if(g!==null){a.getAnimationImage().updateGrid({sw:g.width/h})}};b.addImages=function(g){b.animationData.graphic.images=b.animationData.graphic.images.concat(g)};b.$watch("animationData.graphic.imageData.url",function(h,g){d(function(){if(h!==g&&a.graphicLayer!==null){e.load(h,function(i){b.animationData.graphic.image=i;a.graphicLayer.set({width:i.width,height:i.height}).clear().drawImage(i,0,0);a.getAnimationImage().updateGrid({width:i.width,height:i.height,sw:i.width,sh:i.height})})}})});b.changeGraphic=function(g){b.animationData.graphic.imageData.url=g;b.modalVisible=false};b.changeGridColor=function(g){b.animationData.graphic.gridColor=g;var h=a.getAnimationImage();var i=h.getGrid();i.apply({strokeStyle:g});h.redrawGrid()};b.addFrame=function(h){var g=b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer);a.getAnimation().indexFrame=h;a.addObject();a.frameLayers.push(g)};b.selectFrame=function(g){console.log("selecting frame "+g);a.getAnimation().indexFrame=g;b.animationCanvas.layers.forEach(function(i,h){if(i.type!=="grid"){if(h===g){i.opacity=1}else{i.opacity=0}}})};b.initController=function(){b.animationCanvas=CE.createEngine({container:"#canvas-container",width:535,height:400});var i=a.getAnimationImage();a.graphicLayer=i.createLayer({name:"graphic-layer"});var j=b.animationCanvas;var h=j.getMouseReader();var g=j.getKeyReader();j.getGridLayer({append:false,width:j.width,height:j.height});g.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(a.selectedObject!==null&&a.selectedObject.parent!==null){var k=a.selectedObject;var l=k.parent;l.remove(a.selectedObject);a.selectedObject=null;a.getAnimation().frames.forEach(function(n){var m=n.imageSets.indexOf(k);if(m!==-1){n.removeImageSet(k);return false}})}});g.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_UP],function(){var k=a.selectedObject;if(k!==null){if(k.parent!==null){k.parent.moveUp(k)}}});g.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_DOWN],function(){var k=a.selectedObject;if(k!==null){if(k.parent!==null){k.parent.moveDown(k)}}});h.onmousedown(1,function(){var k=this;var q=k.lastDown.left;var m=a.frameLayers[a.getAnimation().indexFrame];if(m!==undefined){var o=m.objects;var l=null;var n=false;if(a.selectedObject!==null){a.selectedObject.selected=false;a.selectedObject.canvasLayer.refresh();a.selectedObject=null}o.forEach(function(r){var p=(q.x-r.dx)+r.sx;var s=(q.y-r.dy)+r.sy;if(!f.isPixelTransparent(r.image,p,s)){l=r;l.selected=true;l.odx=l.dx;l.ody=l.dy;a.selectedObject=l;n=true;m.refresh();return false}if(n){return false}})}});h.onmouseout(function(){b.cursor={x:0,y:0};b.$apply()});h.onmousemove(function(){var t=this;var q=a.selectedObject;var o=t.lastMove;b.cursor=o;b.$apply();if(t.left&&q!==null){var k=t.lastDown.left;var u=CE.Math.vmv(o,k);var x=u.x+q.odx;var w=u.y+q.ody;var l=j.getGrid().width;var v=j.getGrid().height;var n=Math.floor(x/32)*32;var s=Math.floor(w/32)*32;var m=n+32;var r=s+32;if((x-n)<(m-(x+q.dWidth))){x=n}else{x=m}if((w-s)<=(r-(w+q.dHeight))){w=s}else{w=r}q.dx=x;q.dy=w;if(q.canvasLayer!==null){q.canvasLayer.refresh()}}})};a.getAnimationImage=function(){var h=this;if(h.animationImage===null){h.animationImage=CE.createEngine({container:"#animations",width:500,height:500,selectable:true,draggable:true,scalable:true});var i=function(q,p){var o=h.animationImage.getGrid();var r=null;if(o.checkedSets.length>0){r=o.checkedSets[0]}if(r!==null){var n=o.rectSets[r.i+q]!==undefined?r.i+q:0;var l=o.rectSets[n][r.j+p]!==undefined?r.j+p:0;if(o.rectSets[n][l]!==undefined){var m=o.rectSets[n][l];o.checkedSets=[m];o.apply({fillStyle:"transparent",state:0});m.set({fillStyle:"rgba(0,0,150,0.5)",state:1});h.animationImage.refreshGridLayer();var k=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:m.x,sy:m.y,sWidth:m.width,sHeight:m.height,dWidth:m.width,dHeight:m.height,dx:(k.width/2)-(m.width/2),dy:(k.height/2)-(m.height/2)}}}};var g=h.animationImage.getKeyReader();g.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){console.log("keydown!");i(1,0)});g.onSequence([CE.KeyReader.Keys.KEY_UP],function(){console.log("keydown!");i(-1,0)});g.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){console.log("keydown!");i(0,-1)});g.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){console.log("keydown!");i(0,1)});g.onSequence([CE.KeyReader.Keys.KEY_F],function(){h.addFrame()});g.onSequence([CE.KeyReader.Keys.KEY_O],function(){h.addObject()});h.animationImage.onAreaSelect(function(o,m){var j=h.animationImage.getMouseReader();var k=m.getRectsFromArea(o);m.checkedSets=k;if(j.left){m.apply({fillStyle:"transparent"});k.forEach(function(p){p.set({fillStyle:"rgba(0,0,150,0.5)",state:1})})}else{m.apply({fillStyle:"transparent"},function(){return this.state!==1});k.forEach(function(p){if(p.state!==1){p.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}})}if(k.length>0){var n=k[0];var l=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:n.x,sy:n.y,dWidth:n.width,dHeight:n.height,sWidth:n.width,sHeight:n.height,dx:(l.width/2)-(n.width/2),dy:(l.height/2)-(n.height/2)}}})}return h.animationImage};b.removeFrame=function(g){b.animationCanvas.removeLayer(g);a.frameLayers.splice(g,1);a.getAnimation().remove(g);b.selectFrame(g-1)};a.getAnimation=function(){var g=this;var h=b.animationCanvas;if(b.animation===null){var i=new CE.Animation({speed:7,width:h.width,height:h.height,indexFrame:0,repeat:true});i.onStep(function(j){b.selectFrame(j);b.$apply()});b.animation=i}return b.animation};a.addObject=function(){var g=this;if(b.animationData.graphic.croppedArea!==null){var j=b.animation.indexFrame;var h=b.animationCanvas.getLayer(j);if(h!==null&&h instanceof CE.ObjectLayer){var i=new CE.ImageSet(b.animationData.graphic.croppedArea);h.add(i);g.getAnimation().frames[j]=i}}};b.showModal=function(){b.modalVisible=true};b.hideModal=function(){b.modalVisible=false};b.playAnimation=function(){a.getAnimation().execute()};b.pauseAnimation=function(){a.getAnimation().pause()};b.stopAnimation=function(){a.getAnimation().stop()}}]);