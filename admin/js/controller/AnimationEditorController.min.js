app.controller("AnimationEditorController",["$rootScope","ImageLoader",function(b,c){var a=this;b.init=function(){b.page.title="Editor de Animações"};b.animationData={animation:{frames:[]},layers:{canvas:[],width:560,height:400,visible:null},graphic:{rows:1,cols:1,gridColor:"#000000",images:[],image:null},functions:{initAnimation:function(){a.init()},addElement:function(d){a.addFrame(d)}}};b.changeRows=function(d){b.animationData.graphic.rows=d;a.changeRows(d)};b.changeCols=function(d){b.animationData.graphic.cols=d;a.changeCols(d)};b.addImages=function(d){b.animationData.graphic.images=b.animationData.graphic.images.concat(d)};b.changeGraphic=function(){a.changeGraphic(b.animationData.graphic.image.url)};b.changeGridColor=function(d){b.graphic.gridColor=d;a.changeGridColor(b.animationData.graphic.gridColor)};b.addFrame=function(){b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer)};b.removeFrame=function(d){b.animationCanvas.removeLayer(d)};b.selectFrame=function(d){b.animationData.layers.visible=d};b.animationCanvas=CE.createEngine({container:"#canvas-container",width:560,height:400});a.animationImage=null;a.graphicLayer=null;a.frameLayers=[];a.currentFrame=0;a.graphics=[];a.image=null;a.croppedImage=null;a.animation=null;a.playing=false;a.rows=1;a.cols=1;a.maxLayer=0;a.selectedObject=null;b.initController=function(){var f=a.getAnimationImage();a.graphicLayer=f.createLayer({name:"graphic-layer"});var g=b.animationCanvas;var e=g.getMouseReader();var d=g.getKeyReader();g.updateGrid({width:g.getWidth(),height:g.getHeight(),sw:32,sh:32,opacity:0.1});d.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(a.selectedObject!==null&&a.selectedObject.parent!==null){var h=a.selectedObject;var i=h.parent;i.remove(a.selectedObject);a.selectedObject=null;a.getAnimation().frames.forEach(function(k){var j=k.imageSets.indexOf(h);if(j!==-1){k.removeImageSet(h);return false}})}});d.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_UP],function(){var h=a.selectedObject;if(h!=null){if(h.parent!=null){h.parent.moveUp(h)}}});d.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_DOWN],function(){var h=a.selectedObject;if(h!=null){if(h.parent!=null){h.parent.moveDown(h)}}});e.onmousedown(1,function(){var h=this;var m=h.lastDown.left;var j=a.frameLayers[a.currentFrame];if(j!=undefined){var l=j.objects;var i=null;var k=false;if(a.selectedObject!==null){a.selectedObject.selected=false;a.selectedObject.parent.refresh();a.selectedObject=null}l.forEach(function(o){var n=m.x-o.x;var p=m.y-o.y;if(!o.isTransparent(n,p)){i=o;i.selected=true;i.oldX=i.x;i.oldY=i.y;a.selectedObject=i;k=true;j.refresh();return false}if(k){return false}})}});e.onmousemove(function(){var q=this;var m=a.selectedObject;if(q.left&&m!==null){var h=q.lastDown.left;var l=q.lastMove;var s=Math.vmv(l,h);var r={x:s.x+m.oldX,y:s.y+m.oldY};var i=g.getGrid().width;var t=g.getGrid().height;var k=Math.floor(r.x/32)*32;var o=Math.floor(r.y/32)*32;var j=k+32;var n=o+32;if((r.x-k)<(j-(r.x+m.width))){r.x=k}else{r.x=j}if((r.y-o)<=(n-(r.y+m.height))){r.y=o}else{r.y=n}m.set(r);if(m.parent!==null){m.parent.refresh()}}})};a.getAnimationImage=function(){var e=this;if(e.animationImage===null){e.animationImage=CE.createEngine({container:"#animations",width:560,height:400,selectable:true,draggable:true,scalable:true});var f=function(o,n){var m=e.animationImage.getGrid();var p=null;if(m.checkedSets.length>0){p=m.checkedSets[0]}if(p!==null){var l=m.rectSets[p.i+o]!==undefined?p.i+o:0;var h=m.rectSets[l][p.j+n]!==undefined?p.j+n:0;if(m.rectSets[l][h]!==undefined){var k=m.rectSets[l][h];m.checkedSets=[k];m.apply({fillStyle:"transparent",state:0});k.set({fillStyle:"rgba(0,0,150,0.5)",state:1});e.animationImage.refreshGridLayer();var g=b.animationCanvas;e.croppedImage=new CE.ImageSet({url:e.image.src,sx:k.x,sy:k.y,width:k.width,height:k.height});e.croppedImage.set({x:(g.getWidth()/2)-(k.width/2),y:(g.getHeight()/2)-(k.height/2)})}}};var d=e.animationImage.getKeyReader();d.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){console.log("keydown!");f(1,0)});d.onSequence([CE.KeyReader.Keys.KEY_UP],function(){console.log("keydown!");f(-1,0)});d.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){console.log("keydown!");f(0,-1)});d.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){console.log("keydown!");f(0,1)});d.onSequence([CE.KeyReader.Keys.KEY_F],function(){e.addFrame()});d.onSequence([CE.KeyReader.Keys.KEY_O],function(){e.addObject()});e.animationImage.onAreaSelect(function(l,j){var g=e.animationImage.getMouseReader();var h=j.getRectsFromArea(l);j.checkedSets=h;if(g.left){j.apply({fillStyle:"transparent"});h.forEach(function(m){m.set({fillStyle:"rgba(0,0,150,0.5)",state:1})})}else{j.apply({fillStyle:"transparent"},function(){return this.state!=1});h.forEach(function(m){if(m.state!==1){m.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}})}if(h.length>0){var k=h[0];var i=b.animationCanvas;e.croppedImage=new CE.ImageSet({url:e.image.src,sx:k.x,sy:k.y,width:k.width,height:k.height,sWidth:k.width,sHeight:k.height});e.croppedImage.set({x:(i.getWidth()/2)-(k.width/2),y:(i.getHeight()/2)-(k.height/2)})}})}return e.animationImage};a.changeGraphic=function(e){var d=this;c.load(e,function(f){d.image=f;d.graphicLayer.set({width:f.width,height:f.height}).clear().drawImage(f,0,0);d.getAnimationImage().updateGrid({width:f.width,height:f.height,sw:f.width,sh:f.height})})};a.changeRows=function(e){var d=this;if(d.image!==null){d.getAnimationImage().updateGrid({sh:d.image.height/e})}d.rows=e};a.changeCols=function(e){var d=this;if(d.image!==null){d.getAnimationImage().updateGrid({sw:d.image.width/e})}d.cols=e};a.changeGridColor=function(e){var d=this;var f=d.getAnimationImage();var g=f.getGrid();g.apply({strokeStyle:e});f.redrawGrid()};a.removeFrame=function(d){b.animationCanvas.removeLayer(d)};a.getAnimation=function(){var d=this;var e=b.animationCanvas;if(d.animation===null){d.animation=new CE.Animation({speed:7,width:e.width,height:e.height});d.animation.onStep(function(f){d.getFrameList().itemSelect(f)})}return d.animation};a.addObject=function(){var d=this;if(d.croppedImage!==null){var e=b.animationCanvas.getLayer(d.currentFrame);if(e!==null&&e instanceof CE.ObjectLayer){var f=d.croppedImage.clone();e.add(f);d.getAnimation().frames[d.currentFrame]=f.getGraphic()}}}}]);