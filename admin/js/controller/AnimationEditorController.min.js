app.controller("AnimationEditorController",["$rootScope","ImageLoader","$timeout",function(b,d,c){var a=this;b.init=function(){b.page.title="Editor de Animações"};b.canvasId="canvas-container";b.animationData={graphic:{rows:1,cols:1,gridColor:"#000000",images:[],imageData:null,image:null,croppedArea:{}},currentFrame:0};b.animation=null;b.changeRows=function(f){b.animationData.graphic.rows=f;var e=b.animationData.graphic.image;if(e!==null){a.getAnimationImage().updateGrid({sh:e.height/f})}};b.changeCols=function(f){b.animationData.graphic.cols=f;var e=b.animationData.graphic.image;if(e!==null){a.getAnimationImage().updateGrid({sw:e.width/f})}};b.addImages=function(e){b.animationData.graphic.images=b.animationData.graphic.images.concat(e)};b.changeGraphic=function(){var e=b.animationData.graphic.imageData.url;d.load(e,function(f){b.animationData.graphic.image=f;a.graphicLayer.set({width:f.width,height:f.height}).clear().drawImage(f,0,0);a.getAnimationImage().updateGrid({width:f.width,height:f.height,sw:f.width,sh:f.height})})};b.changeGridColor=function(e){b.animationData.graphic.gridColor=e;var f=a.getAnimationImage();var g=f.getGrid();g.apply({strokeStyle:e});f.redrawGrid()};b.addFrame=function(e){b.animationCanvas.createLayer({append:false,width:b.animationCanvas.width,height:b.animationCanvas.height},CE.ObjectLayer);a.getAnimation().indexFrame=e;a.addObject()};b.selectFrame=function(e){console.log("selecting frame "+e);a.getAnimation().indexFrame=e;b.animationCanvas.layers.forEach(function(g,f){if(g.type!=="grid"){if(f===e){g.opacity=1}else{g.opacity=0}}})};b.animationCanvas=CE.createEngine({container:"#canvas-container",width:535,height:400});a.animationImage=null;a.graphicLayer=null;a.graphics=[];a.animation=null;a.playing=false;a.rows=1;a.cols=1;a.maxLayer=0;a.selectedObject=null;b.initController=function(){var g=a.getAnimationImage();a.graphicLayer=g.createLayer({name:"graphic-layer"});var h=b.animationCanvas;var f=h.getMouseReader();var e=h.getKeyReader();h.getGridLayer({append:false,width:h.width,height:h.height});e.onSequence([CE.KeyReader.Keys.KEY_DEL],function(){console.log("delete...");if(a.selectedObject!==null&&a.selectedObject.parent!==null){var i=a.selectedObject;var j=i.parent;j.remove(a.selectedObject);a.selectedObject=null;a.getAnimation().frames.forEach(function(l){var k=l.imageSets.indexOf(i);if(k!==-1){l.removeImageSet(i);return false}})}});e.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_UP],function(){var i=a.selectedObject;if(i!==null){if(i.parent!==null){i.parent.moveUp(i)}}});e.onSequence([CE.KeyReader.Keys.KEY_CTRL,CE.KeyReader.Keys.KEY_DOWN],function(){var i=a.selectedObject;if(i!==null){if(i.parent!==null){i.parent.moveDown(i)}}});f.onmousedown(1,function(){var i=this;var n=i.lastDown.left;var k=a.frameLayers[b.animation.indexFrame];if(k!==undefined){var m=k.objects;var j=null;var l=false;if(a.selectedObject!==null){a.selectedObject.selected=false;a.selectedObject.parent.refresh();a.selectedObject=null}m.forEach(function(p){var o=n.x-p.x;var q=n.y-p.y;if(!p.isTransparent(o,q)){j=p;j.selected=true;j.oldX=j.x;j.oldY=j.y;a.selectedObject=j;l=true;k.refresh();return false}if(l){return false}})}});f.onmousemove(function(){var r=this;var n=a.selectedObject;if(r.left&&n!==null){var i=r.lastDown.left;var m=r.lastMove;var t=Math.vmv(m,i);var s={x:t.x+n.oldX,y:t.y+n.oldY};var j=h.getGrid().width;var u=h.getGrid().height;var l=Math.floor(s.x/32)*32;var q=Math.floor(s.y/32)*32;var k=l+32;var o=q+32;if((s.x-l)<(k-(s.x+n.width))){s.x=l}else{s.x=k}if((s.y-q)<=(o-(s.y+n.height))){s.y=q}else{s.y=o}n.set(s);if(n.parent!==null){n.parent.refresh()}}})};a.getAnimationImage=function(){var f=this;if(f.animationImage===null){f.animationImage=CE.createEngine({container:"#animations",width:530,height:400,selectable:true,draggable:true,scalable:true});var g=function(p,o){var n=f.animationImage.getGrid();var q=null;if(n.checkedSets.length>0){q=n.checkedSets[0]}if(q!==null){var m=n.rectSets[q.i+p]!==undefined?q.i+p:0;var k=n.rectSets[m][q.j+o]!==undefined?q.j+o:0;if(n.rectSets[m][k]!==undefined){var l=n.rectSets[m][k];n.checkedSets=[l];n.apply({fillStyle:"transparent",state:0});l.set({fillStyle:"rgba(0,0,150,0.5)",state:1});f.animationImage.refreshGridLayer();var h=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:l.x,sy:l.y,sWidth:l.width,sHeight:l.height,dWidth:l.width,dHeight:l.height,x:(h.width/2)-(l.width/2),y:(h.height/2)-(l.height/2)}}}};var e=f.animationImage.getKeyReader();e.onSequence([CE.KeyReader.Keys.KEY_DOWN],function(){console.log("keydown!");g(1,0)});e.onSequence([CE.KeyReader.Keys.KEY_UP],function(){console.log("keydown!");g(-1,0)});e.onSequence([CE.KeyReader.Keys.KEY_LEFT],function(){console.log("keydown!");g(0,-1)});e.onSequence([CE.KeyReader.Keys.KEY_RIGHT],function(){console.log("keydown!");g(0,1)});e.onSequence([CE.KeyReader.Keys.KEY_F],function(){f.addFrame()});e.onSequence([CE.KeyReader.Keys.KEY_O],function(){f.addObject()});f.animationImage.onAreaSelect(function(m,k){var h=f.animationImage.getMouseReader();var i=k.getRectsFromArea(m);k.checkedSets=i;if(h.left){k.apply({fillStyle:"transparent"});i.forEach(function(n){n.set({fillStyle:"rgba(0,0,150,0.5)",state:1})})}else{k.apply({fillStyle:"transparent"},function(){return this.state!==1});i.forEach(function(n){if(n.state!==1){n.set({fillStyle:"rgba(0,0,150,0.5)",state:0})}})}if(i.length>0){var l=i[0];var j=b.animationCanvas;b.animationData.graphic.croppedArea={image:b.animationData.graphic.image,sx:l.x,sy:l.y,dWidth:l.width,dHeight:l.height,sWidth:l.width,sHeight:l.height,x:(j.width/2)-(l.width/2),y:(j.height/2)-(l.height/2)}}})}return f.animationImage};b.removeFrame=function(e){b.animationCanvas.removeLayer(e);b.selectFrame(e-1)};a.getAnimation=function(){var e=this;var f=b.animationCanvas;if(b.animation===null){var g=new CE.Animation({speed:7,width:f.width,height:f.height,indexFrame:0});g.onStep(function(h){b.selectFrame(h)});b.animation=g}return b.animation};a.addObject=function(){var e=this;if(b.animationData.graphic.croppedArea!==null){var h=b.animation.indexFrame;var f=b.animationCanvas.getLayer(h);if(f!==null&&f instanceof CE.ObjectLayer){var g=_.clone(b.animationData.graphic.croppedArea);f.add(g);e.getAnimation().frames[h]=g}}}}]);